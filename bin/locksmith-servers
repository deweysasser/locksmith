#!/bin/bash

# Purpose:  manage the servers list

help() {
       cat<<EOF
usage: locksmith servers COMMAND options
EOF
}

# command add:  add a server to the list
add() {
    cp "$ServersFile" "$ServersFile.bak"
    ( 
	for s in "$@" ; do
	    echo "$s"
	done
	cat "$ServersFile.bak"
    ) | sort -u > "$ServersFile"
}


# command list:  show the servers in the list
list() {
    test -f "$ServersFile" && cat "$ServersFile"
}

# command rm:  remove a server from the list
rm() {
    for s in "$@" ;do 
	cp "$ServersFile" "$ServersFile.bak"
	egrep -v "^$s\$" "$ServersFile.bak" | sort -u > "$ServersFile"
    done
}

# command fetch:  fetch the keys from a server or servers
fetch() {
    sdir=`ensureConfigDir servers`
    if [ $# -lt 1 ] ; then
	servers=`list`
    else
	servers="$*"
    fi
    for s in $servers; do
	file=`fileEscape $sdir/$s.txt`
	# Remember the server for furture reference
	add "$s"
	ssh "$s" cat .ssh/authorized_keys > $file
	show "$s"
    done
}

show() {
    sdir=`ensureConfigDir servers`
    for s in ${*:-`list`}; do
	file=`fileEscape $sdir/$s.txt`
#	perl -n -e 'print "$1\n" if /^ssh-(\w+)/'  "$file"
	perl -n -e 'print "$1 ...$2 $3\n" if /^ssh-(\w+) [^\s]+([^\s]{12}) (.*)/'  "$file"
    done
}

if [ "$#" -lt 1 ] ; then
    command="list"
else
    command=$1
    shift
fi


source `dirname $0`/locksmith-common

ServersFile=`ensureConfigDir`/servers.txt


case $command in 
    add) add "$@";;
    list) list "$@" ;; 
    rm) rm "$@";;
    # a catch-all placeholder for now
    *) $command "$@";;
esac


   