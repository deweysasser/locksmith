#!/bin/bash
# Purpose:  common functions for locksmith programs.  Not exectuable itself.

getConfigDir() {
    echo $HOME/.locksmith
}

ensureConfigDir() {
    path="$1"
    dir=`getConfigDir`
    test -d "$dir/$path" || mkdir -p "$dir/$path"
    echo "$dir/$path"
}

fileEscape() {
    echo "$@" | tr '@' '_'
}



verbose() {
    echo "$@"
}

mainloop() {
    defaultCommand="$1"; shift

if [ "$#" -lt 1 ] ; then
    command=$defaultCommand
else
    command=$1
    shift
fi

$command "$@"
}

######################################################################
# Key specific functions
######################################################################

enrollKey() {

    if [ -f "$1" ] ; then
	cat "$1" | while read LINE; do
	    enrollKey $LINE
	done
	return;
    fi

    date=`date +%Y%m%d%H%M%S`
#    type="$1"; shift
#    key="$1"; shift

    file=`ensureConfigDir`/keys.txt

    test -f "$file" || touch "$file"

    cp "$file" "$file.bak"
    (
	echo $date "$@"
	cat "$file.bak"
    ) | keysort > "$file"
}

keysort() {
    sort -k 1,3  "$@" | sort -k 2,3 -u
}

resortKeyfile() {
    file="$1" 

    cp "$file" "$file.bak"
    keysort "$file.bak" > "$file"
}

showKeys() {
    (
	if [ -f "$1" ] ; then
	    file="$1"; shift
	    if [ $# -gt 0 ] ; then
		grep "$@" "$file"
	    elif [ -f "$file" ] ; then
		cat "$file"
	    fi
	else 
	    echo "$@"
	fi
    ) | keysort | perl -n -e 'print "($2) $3 ...$4 $5\n" if /^((\d+) )?ssh-(\w+) [^\s]+([^\s]{12}) (.*)/'  
}